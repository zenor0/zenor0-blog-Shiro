class ie{constructor(e){this.selfOptions=e||{},this.pipes={}}options(e){return e&&(this.selfOptions=e),this.selfOptions}pipe(e,i){let t=i;if(typeof e=="string"){if(typeof t>"u")return this.pipes[e];this.pipes[e]=t}if(e&&e.name){if(t=e,t.processor===this)return t;this.pipes[t.name]=t}return t.processor=this,t}process(e,i){let t=e;t.options=this.options();let r=i||e.pipe||"default",s;for(;r;)typeof t.nextAfterChildren<"u"&&(t.next=t.nextAfterChildren,t.nextAfterChildren=null),typeof r=="string"&&(r=this.pipe(r)),r.process(t),s=r,r=null,t&&t.next&&(t=t.next,r=t.pipe||s);return t.hasResult?t.result:void 0}}class _{constructor(e){this.name=e,this.filters=[]}process(e){if(!this.processor)throw new Error("add this pipe to a processor before using it");const i=this.debug,t=this.filters.length,r=e;for(let s=0;s<t;s++){const n=this.filters[s];if(i&&this.log(`filter: ${n.filterName}`),n(r),typeof r=="object"&&r.exiting){r.exiting=!1;break}}!r.next&&this.resultCheck&&this.resultCheck(r)}log(e){console.log(`[jsondiffpatch] ${this.name} pipe, ${e}`)}append(...e){return this.filters.push(...e),this}prepend(...e){return this.filters.unshift(...e),this}indexOf(e){if(!e)throw new Error("a filter name is required");for(let i=0;i<this.filters.length;i++)if(this.filters[i].filterName===e)return i;throw new Error(`filter not found: ${e}`)}list(){return this.filters.map(e=>e.filterName)}after(e,...i){const t=this.indexOf(e);return this.filters.splice(t+1,0,...i),this}before(e,...i){const t=this.indexOf(e);return this.filters.splice(t,0,...i),this}replace(e,...i){const t=this.indexOf(e);return this.filters.splice(t,1,...i),this}remove(e){const i=this.indexOf(e);return this.filters.splice(i,1),this}clear(){return this.filters.length=0,this}shouldHaveResult(e){if(e===!1){this.resultCheck=null;return}if(!this.resultCheck)return this.resultCheck=i=>{if(!i.hasResult){console.log(i);const t=new Error(`${this.name} failed`);throw t.noResult=!0,t}},this}}class I{setResult(e){return this.result=e,this.hasResult=!0,this}exit(){return this.exiting=!0,this}push(e,i){return e.parent=this,typeof i<"u"&&(e.childName=i),e.root=this.root||this,e.options=e.options||this.options,this.children?(this.children[this.children.length-1].next=e,this.children.push(e)):(this.children=[e],this.nextAfterChildren=this.next||null,this.next=e),e.next=this,this}}function re(l){const e=/^\/(.*)\/([gimyu]*)$/.exec(l.toString());return new RegExp(e[1],e[2])}function C(l){if(typeof l!="object")return l;if(l===null)return null;if(Array.isArray(l))return l.map(C);if(l instanceof Date)return new Date(l.getTime());if(l instanceof RegExp)return re(l);const e={};for(const i in l)Object.prototype.hasOwnProperty.call(l,i)&&(e[i]=C(l[i]));return e}class p extends I{constructor(e,i){super(),this.left=e,this.right=i,this.pipe="diff"}setResult(e){if(this.options.cloneDiffValues&&typeof e=="object"){const i=typeof this.options.cloneDiffValues=="function"?this.options.cloneDiffValues:C;typeof e[0]=="object"&&(e[0]=i(e[0])),typeof e[1]=="object"&&(e[1]=i(e[1]))}return super.setResult(e)}}class N extends I{constructor(e,i){super(),this.left=e,this.delta=i,this.pipe="patch"}}class P extends I{constructor(e){super(),this.delta=e,this.pipe="reverse"}}const H=function(e){if(e.left===e.right){e.setResult(void 0).exit();return}if(typeof e.left>"u"){if(typeof e.right=="function")throw new Error("functions are not supported");e.setResult([e.right]).exit();return}if(typeof e.right>"u"){e.setResult([e.left,0,0]).exit();return}if(typeof e.left=="function"||typeof e.right=="function")throw new Error("functions are not supported");if(e.leftType=e.left===null?"null":typeof e.left,e.rightType=e.right===null?"null":typeof e.right,e.leftType!==e.rightType){e.setResult([e.left,e.right]).exit();return}if(e.leftType==="boolean"||e.leftType==="number"){e.setResult([e.left,e.right]).exit();return}if(e.leftType==="object"&&(e.leftIsArray=Array.isArray(e.left)),e.rightType==="object"&&(e.rightIsArray=Array.isArray(e.right)),e.leftIsArray!==e.rightIsArray){e.setResult([e.left,e.right]).exit();return}e.left instanceof RegExp&&(e.right instanceof RegExp?e.setResult([e.left.toString(),e.right.toString()]).exit():e.setResult([e.left,e.right]).exit())};H.filterName="trivial";const k=function(e){if(typeof e.delta>"u"){e.setResult(e.left).exit();return}if(e.nested=!Array.isArray(e.delta),e.nested)return;const i=e.delta;if(i.length===1){e.setResult(i[0]).exit();return}if(i.length===2){if(e.left instanceof RegExp){const t=/^\/(.*)\/([gimyu]+)$/.exec(i[1]);if(t){e.setResult(new RegExp(t[1],t[2])).exit();return}}e.setResult(i[1]).exit();return}i.length===3&&i[2]===0&&e.setResult(void 0).exit()};k.filterName="trivial";const L=function(e){if(typeof e.delta>"u"){e.setResult(e.delta).exit();return}if(e.nested=!Array.isArray(e.delta),e.nested)return;const i=e.delta;if(i.length===1){e.setResult([i[0],0,0]).exit();return}if(i.length===2){e.setResult([i[1],i[0]]).exit();return}i.length===3&&i[2]===0&&e.setResult([i[0]]).exit()};L.filterName="trivial";const B=l=>{if(!l||!l.children)return;const e=l.children.length;let i,t=l.result;for(let r=0;r<e;r++)i=l.children[r],!(typeof i.result>"u")&&(t=t||{},t[i.childName]=i.result);t&&l.leftIsArray&&(t._t="a"),l.setResult(t).exit()};B.filterName="collectChildren";const V=l=>{if(l.leftIsArray||l.leftType!=="object")return;const e=l.left,i=l.right;let t,r;const s=l.options.propertyFilter;for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(s&&!s(t,l)||(r=new p(e[t],i[t]),l.push(r,t)));for(t in i)Object.prototype.hasOwnProperty.call(i,t)&&(s&&!s(t,l)||typeof e[t]>"u"&&(r=new p(void 0,i[t]),l.push(r,t)));if(!l.children||l.children.length===0){l.setResult(void 0).exit();return}l.exit()};V.filterName="objects";const W=function(e){if(!e.nested)return;const i=e.delta;if(i._t)return;const t=i;let r,s;for(r in t)s=new N(e.left[r],t[r]),e.push(s,r);e.exit()};W.filterName="objects";const q=function(e){if(!e||!e.children||e.delta._t)return;const t=e.left,r=e.children.length;let s;for(let n=0;n<r;n++){s=e.children[n];const f=s.childName;Object.prototype.hasOwnProperty.call(e.left,f)&&s.result===void 0?delete t[f]:t[f]!==s.result&&(t[f]=s.result)}e.setResult(t).exit()};q.filterName="collectChildren";const S=function(e){if(!e.nested||e.delta._t)return;const t=e.delta;let r,s;for(r in t)s=new P(t[r]),e.push(s,r);e.exit()};S.filterName="objects";const G=l=>{if(!l||!l.children||l.delta._t)return;const i=l.children.length;let t;const r={};for(let s=0;s<i;s++){t=l.children[s];const n=t.childName;r[n]!==t.result&&(r[n]=t.result)}l.setResult(r).exit()};G.filterName="collectChildren";const se=function(l,e,i,t){return l[i]===e[t]},le=function(l,e,i,t){const r=l.length,s=e.length;let n,f;const h=new Array(r+1);for(n=0;n<r+1;n++)for(h[n]=new Array(s+1),f=0;f<s+1;f++)h[n][f]=0;for(h.match=i,n=1;n<r+1;n++)for(f=1;f<s+1;f++)i(l,e,n-1,f-1,t)?h[n][f]=h[n-1][f-1]+1:h[n][f]=Math.max(h[n-1][f],h[n][f-1]);return h},ne=function(l,e,i,t){let r=e.length,s=i.length;const n={sequence:[],indices1:[],indices2:[]};for(;r!==0&&s!==0;)if(l.match(e,i,r-1,s-1,t))n.sequence.unshift(e[r-1]),n.indices1.unshift(r-1),n.indices2.unshift(s-1),--r,--s;else{const h=l[r][s-1],o=l[r-1][s];h>o?--s:--r}return n},fe=function(l,e,i,t){const r=t||{},s=le(l,e,i||se,r);return ne(s,l,e,r)},he={get:fe},g=3;function ae(l,e,i,t){for(let r=0;r<i;r++){const s=l[r];for(let n=0;n<t;n++){const f=e[n];if(r!==n&&s===f)return!0}}}function b(l,e,i,t,r){const s=l[i],n=e[t];if(s===n)return!0;if(typeof s!="object"||typeof n!="object")return!1;const f=r.objectHash;if(!f)return r.matchByPosition&&i===t;r.hashCache1=r.hashCache1||[];let h=r.hashCache1[i];if(typeof h>"u"&&(r.hashCache1[i]=h=f(s,i)),typeof h>"u")return!1;r.hashCache2=r.hashCache2||[];let o=r.hashCache2[t];return typeof o>"u"&&(r.hashCache2[t]=o=f(n,t)),typeof o>"u"?!1:h===o}const U=function(e){if(!e.leftIsArray)return;const i={objectHash:e.options&&e.options.objectHash,matchByPosition:e.options&&e.options.matchByPosition};let t=0,r=0,s,n,f;const h=e.left,o=e.right,d=h.length,u=o.length;let c;for(d>0&&u>0&&!i.objectHash&&typeof i.matchByPosition!="boolean"&&(i.matchByPosition=!ae(h,o,d,u));t<d&&t<u&&b(h,o,t,t,i);)s=t,c=new p(h[s],o[s]),e.push(c,s),t++;for(;r+t<d&&r+t<u&&b(h,o,d-1-r,u-1-r,i);)n=d-1-r,f=u-1-r,c=new p(h[n],o[f]),e.push(c,f),r++;let a;if(t+r===d){if(d===u){e.setResult(void 0).exit();return}for(a=a||{_t:"a"},s=t;s<u-r;s++)a[s]=[o[s]];e.setResult(a).exit();return}if(t+r===u){for(a=a||{_t:"a"},s=t;s<d-r;s++)a[`_${s}`]=[h[s],0,0];e.setResult(a).exit();return}delete i.hashCache1,delete i.hashCache2;const m=h.slice(t,d-r),j=o.slice(t,u-r),R=he.get(m,j,b,i),v=[];for(a=a||{_t:"a"},s=t;s<d-r;s++)R.indices1.indexOf(s-t)<0&&(a[`_${s}`]=[h[s],0,0],v.push(s));let $=!0;e.options&&e.options.arrays&&e.options.arrays.detectMove===!1&&($=!1);let M=!1;e.options&&e.options.arrays&&e.options.arrays.includeValueOnMove&&(M=!0);const O=v.length;for(s=t;s<u-r;s++){const F=R.indices2.indexOf(s-t);if(F<0){let T=!1;if($&&O>0){for(let w=0;w<O;w++)if(n=v[w],b(m,j,n-t,s-t,i)){a[`_${n}`].splice(1,2,s,g),M||(a[`_${n}`][0]=""),f=s,c=new p(h[n],o[f]),e.push(c,f),v.splice(w,1),T=!0;break}}T||(a[s]=[o[s]])}else n=R.indices1[F]+t,f=R.indices2[F]+t,c=new p(h[n],o[f]),e.push(c,f)}e.setResult(a).exit()};U.filterName="arrays";const E={numerically(l,e){return l-e},numericallyBy(l){return(e,i)=>e[l]-i[l]}},X=function(e){if(!e.nested)return;const i=e.delta;if(i._t!=="a")return;let t,r;const s=i,n=e.left;let f=[],h=[];const o=[];for(t in s)if(t!=="_t")if(t[0]==="_"){const a=t;if(s[a][2]===0||s[a][2]===g)f.push(parseInt(t.slice(1),10));else throw new Error(`only removal or move can be applied at original array indices, invalid diff type: ${s[a][2]}`)}else{const a=t;s[a].length===1?h.push({index:parseInt(a,10),value:s[a][0]}):o.push({index:parseInt(a,10),delta:s[a]})}for(f=f.sort(E.numerically),t=f.length-1;t>=0;t--){r=f[t];const a=s[`_${r}`],m=n.splice(r,1)[0];a[2]===g&&h.push({index:a[1],value:m})}h=h.sort(E.numericallyBy("index"));const d=h.length;for(t=0;t<d;t++){const a=h[t];n.splice(a.index,0,a.value)}const u=o.length;let c;if(u>0)for(t=0;t<u;t++){const a=o[t];c=new N(n[a.index],a.delta),e.push(c,a.index)}if(!e.children){e.setResult(n).exit();return}e.exit()};X.filterName="arrays";const Y=function(e){if(!e||!e.children||e.delta._t!=="a")return;const t=e.left,r=e.children.length;let s;for(let n=0;n<r;n++){s=e.children[n];const f=s.childName;t[f]=s.result}e.setResult(t).exit()};Y.filterName="arraysCollectChildren";const z=function(e){if(!e.nested){const n=e.delta;if(n[2]===g){const f=n;e.newName=`_${f[1]}`,e.setResult([f[0],parseInt(e.childName.substring(1),10),g]).exit()}return}const i=e.delta;if(i._t!=="a")return;const t=i;let r,s;for(r in t)r!=="_t"&&(s=new P(t[r]),e.push(s,r));e.exit()};z.filterName="arrays";const oe=(l,e,i)=>{if(typeof e=="string"&&e[0]==="_")return parseInt(e.substring(1),10);if(Array.isArray(i)&&i[2]===0)return`_${e}`;let t=+e;for(const r in l){const s=l[r];if(Array.isArray(s))if(s[2]===g){const n=parseInt(r.substring(1),10),f=s[1];if(f===+e)return n;n<=t&&f>t?t++:n>=t&&f<t&&t--}else s[2]===0?parseInt(r.substring(1),10)<=t&&t++:s.length===1&&parseInt(r,10)<=t&&t--}return t},J=l=>{if(!l||!l.children)return;const e=l.delta;if(e._t!=="a")return;const i=e,t=l.children.length;let r;const s={_t:"a"};for(let n=0;n<t;n++){r=l.children[n];let f=r.newName;typeof f>"u"&&(f=oe(i,r.childName,r.result)),s[f]!==r.result&&(s[f]=r.result)}l.setResult(s).exit()};J.filterName="arraysCollectChildren";const K=function(e){e.left instanceof Date?(e.right instanceof Date?e.left.getTime()!==e.right.getTime()?e.setResult([e.left,e.right]):e.setResult(void 0):e.setResult([e.left,e.right]),e.exit()):e.right instanceof Date&&e.setResult([e.left,e.right]).exit()};K.filterName="dates";const D=2,ue=60;let A=null;function Q(l,e){var i;if(!A){let t;if(!((i=l?.textDiff)===null||i===void 0)&&i.diffMatchPatch)t=new l.textDiff.diffMatchPatch;else{if(!e)return null;const r=new Error("The diff-match-patch library was not provided. Pass the library in through the options or use the `jsondiffpatch/with-text-diffs` entry-point.");throw r.diff_match_patch_not_found=!0,r}A={diff:function(r,s){return t.patch_toText(t.patch_make(r,s))},patch:function(r,s){const n=t.patch_apply(t.patch_fromText(s),r);for(let f=0;f<n[1].length;f++)if(!n[1][f]){const h=new Error("text patch failed");h.textPatchFailed=!0}return n[0]}}}return A}const Z=function(e){if(e.leftType!=="string")return;const i=e.left,t=e.right,r=e.options&&e.options.textDiff&&e.options.textDiff.minLength||ue;if(i.length<r||t.length<r){e.setResult([i,t]).exit();return}const s=Q(e.options);if(!s){e.setResult([i,t]).exit();return}const n=s.diff;e.setResult([n(i,t),0,D]).exit()};Z.filterName="texts";const x=function(e){if(e.nested)return;const i=e.delta;if(i[2]!==D)return;const t=i,r=Q(e.options,!0).patch;e.setResult(r(e.left,t[0])).exit()};x.filterName="texts";const de=function(l){let e,i,t,r,s=null;const n=/^@@ +-(\d+),(\d+) +\+(\d+),(\d+) +@@$/;let f;const h=l.split(`
`);for(e=0,i=h.length;e<i;e++){t=h[e];const o=t.slice(0,1);o==="@"?(s=n.exec(t),f=e,h[f]="@@ -"+s[3]+","+s[4]+" +"+s[1]+","+s[2]+" @@"):o==="+"?(h[e]="-"+h[e].slice(1),h[e-1].slice(0,1)==="+"&&(r=h[e],h[e]=h[e-1],h[e-1]=r)):o==="-"&&(h[e]="+"+h[e].slice(1))}return h.join(`
`)},ee=function(e){if(e.nested)return;const i=e.delta;if(i[2]!==D)return;const t=i;e.setResult([de(t[0]),0,D]).exit()};ee.filterName="texts";class te{constructor(e){this.processor=new ie(e),this.processor.pipe(new _("diff").append(B,H,K,Z,V,U).shouldHaveResult()),this.processor.pipe(new _("patch").append(q,Y,k,x,W,X).shouldHaveResult()),this.processor.pipe(new _("reverse").append(G,J,L,ee,S,z).shouldHaveResult())}options(e){return this.processor.options(e)}diff(e,i){return this.processor.process(new p(e,i))}patch(e,i){return this.processor.process(new N(e,i))}reverse(e){return this.processor.process(new P(e))}unpatch(e,i){return this.patch(e,this.reverse(i))}clone(e){return C(e)}}let y;function ce(l,e){return y||(y=new te),y.diff(l,e)}function pe(l,e){return y||(y=new te),y.patch(l,e)}export{ce as d,pe as p};
